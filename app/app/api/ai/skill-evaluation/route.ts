import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth/next';
import { authOptions } from '@/lib/auth-config';
import { generateSkillEvaluation } from '@/lib/openai';

export const dynamic = 'force-dynamic';

export async function POST(request: NextRequest) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const { 
      playerId, 
      evaluationPeriod = '30days',
      includeComparisons = true,
      includeRecommendations = true
    } = await request.json();

    if (!playerId) {
      return NextResponse.json({ error: 'Player ID is required' }, { status: 400 });
    }

    // Fetch player historical data
    const playerHistory = await fetchPlayerHistory(playerId, evaluationPeriod);
    
    if (!playerHistory) {
      return NextResponse.json({ error: 'Player history not found' }, { status: 404 });
    }

    // Generate skill evaluation using OpenAI
    const evaluation = await generateSkillEvaluation({
      ...playerHistory,
      evaluationPeriod,
      includeComparisons,
      includeRecommendations
    });

    // Save evaluation to database
    await saveEvaluation(playerId, evaluation, session.user.id);

    return NextResponse.json({
      success: true,
      evaluation,
      playerId,
      evaluationPeriod,
      generatedAt: new Date().toISOString()
    });

  } catch (error) {
    console.error('Error in skill evaluation:', error);
    return NextResponse.json(
      { error: 'Failed to generate skill evaluation' },
      { status: 500 }
    );
  }
}

async function fetchPlayerHistory(playerId: string, period: string) {
  try {
    // Mock data - replace with actual database queries
    return {
      playerId,
      period,
      skillMetrics: {
        shooting: {
          current: 7.5,
          previous: 6.8,
          trend: 'improving',
          consistency: 8.2
        },
        dribbling: {
          current: 8.1,
          previous: 7.9,
          trend: 'stable',
          consistency: 8.5
        },
        defense: {
          current: 6.9,
          previous: 6.2,
          trend: 'improving',
          consistency: 7.1
        },
        teamwork: {
          current: 8.8,
          previous: 8.5,
          trend: 'improving',
          consistency: 9.0
        }
      },
      performanceData: {
        drillsCompleted: 45,
        workoutsCompleted: 20,
        averageRating: 7.8,
        improvementRate: 0.15,
        consistencyScore: 8.1,
        effortLevel: 'high'
      },
      recentAchievements: [
        'Improved shooting accuracy by 15%',
        'Completed advanced dribbling sequence',
        'Showed leadership in team drills'
      ],
      areasForImprovement: [
        'Defensive positioning',
        'Free throw consistency',
        'Communication on court'
      ],
      coachNotes: [
        'Shows great determination',
        'Responds well to feedback',
        'Natural leader qualities'
      ]
    };
  } catch (error) {
    console.error('Error fetching player history:', error);
    return null;
  }
}

async function saveEvaluation(playerId: string, evaluation: any, userId: string) {
  try {
    // Mock implementation - replace with actual database save
    console.log('Saving evaluation for player:', playerId);
    console.log('Generated by user:', userId);
    console.log('Evaluation:', evaluation);
    return true;
  } catch (error) {
    console.error('Error saving evaluation:', error);
    return false;
  }
} 